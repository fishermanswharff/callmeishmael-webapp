"use strict";function navbarController(a,b,c){var d=this;c.currentUser(),d.isLoggedIn=function(){return c.isAuthenticated()},d.logout=function(){c.logout().then(function(a){b.path("/login")})}}function loginController(a,b,c,d){var e=this;e.login=function(a){$(loginForm).find("button[type=submit] i.fa").addClass("fa-cog fa-spin"),c.login(a).then(function(a){b.path("/dashboard")})},e.confirm=function(a){var e=b.search(),f={id:e.userId,email:e.userEmail,password:a.password,password_confirmation:a.password_confirmation,confirmed:!0};c.updateUser(f).then(function(a){d("response from updateUser: ",a),b.url("/login")})},e.showPasswordForm=function(){e.forgotPassword=!e.forgotPassword},e.sendPasswordLink=function(b){$(resetPasswordForm).find("button[type=submit] i.fa").addClass("fa-cog fa-spin"),c.sendPasswordLink(b).then(function(b){200===b.status?(a.alert="Your email has been sent. If you did not receive it please check your spam box.",$(resetPasswordForm).find("button[type=submit] i.fa").addClass("fa-check").removeClass("fa-cog fa-spin")):(a.alert="We do not have a record of your email address.",$(resetPasswordForm).find("button[type=submit] i.fa").addClass("fa-times").removeClass("fa-cog fa-spin"))})},e.resetPassword=function(a){d("resetting password");var e=b.search(),f={id:e.userId,email:e.userEmail,password:a.password,password_confirmation:a.password_confirmation,confirmed:!0};c.submitNewPassword(f).then(function(a){b.url("/login")})}}function sidenavController(a,b,c){var d=this;d.isActive=function(a){return b.path()===a}}function dashboardController(a,b,c,d,e){var f=this;f.venues=[],f.phones=[],f.stories=[],f.storyTypes=e();var g=function(){b.fetch().then(function(a){angular.copy(a,f.venues)})},h=function(){d.fetch().then(function(b){angular.copy(b,f.stories),a(f.stories)})},i=function(){c.get().then(function(a){angular.copy(a,f.phones)})};f.activeVenues=function(){var a=[];return f.venues.map(function(b,c){"active"===b.status&&a.push(b)}),a.length},f.pausedVenues=function(){var a=[];return f.venues.map(function(b,c){"paused"===b.status&&a.push(b)}),a.length},f.deleteObject=function(e){a(e);for(var f in e)switch(f){case"story":d.destroy(e).then(function(a){h()});break;case"venue":b.destroy(e).then(function(a){g()});break;case"phone":c.destroy(e).then(function(a){i()})}},g(),h(),i()}function homeController(a,b,c){{var d=document.getElementById("scene");new Parallax(d)}}function formsController(a,b,c,d,e){var f=this;f.storyTypes=["Fixed","Venue","Surprise","Ishmael’s","Post Roll"],f.phoneStatus=["active","inactive","retired","fixable"],f.venues=[],f.phones=[],f.stories=[],f.users=[],f.story={},f.venueStory={},f.phone={},f.venue={},e.fetch().then(function(a){for(var b=0;b<a.length;b++)"active"==a[b].status&&f.venues.push(a[b])}),b.fetchUsers().then(function(b){angular.copy(b,f.users),a(f.users)}),c.get().then(function(a){angular.copy(a,f.phones)}),d.fetch().then(function(a){angular.copy(a,f.stories)}),f.submit=function(b){for(var g in b)switch(g){case"story":d.post(b).then(function(b){a(b)}),f.story={};break;case"phone":c.post(b).then(function(b){a(b)}),f.phone={},a("phone is the object");break;case"venue":e.post(b).then(function(b){a(b)}),f.venue={},a("venue is the object")}},f.hasUser=function(a){}}function venueController(a,b,c,d,e,f,g,h){var i=this;if(i.venue={},i.userVenues=e.currentUser().venues,i.venuePhones=[],i.stories=[],i.buttonAssignments=["1","2","3","4","5","6","7","8","9"],i.getVenue=function(a){f.fetchOne(a).then(function(a){angular.copy(a,i.venue),i.getPhones(i.venue.id)})},i.getPhones=function(a){g.fetch(a).then(function(a){angular.copy(a,i.venuePhones)})},i.getStories=function(){h.fetch().then(function(a){angular.copy(a,i.stories)})},i.isActive=function(a){return c.path()===a},i.submit=function(a){for(var b in a)switch(b){case"button":g.assignButton(a).then(function(a){i.buttonToEdit=null,i.getPhones(i.venue.id)})}},i.editButton=function(a,b,c){i.buttonToEdit=b,i.buttonToEdit.assignment=a,i.buttonToEdit.phone_id=c},d.venueId)i.getVenue(d.venueId);else{var j=i.userVenues.filter(function(a){return null!==a.number_phones?a:void 0});i.getVenue(j[0].id)}i.getStories()}function phoneController(a,b,c,d,e,f,g,h){var i=this;i.currentPhone={},i.venues=[],i.ishmaelStories=[],i.availableStories=[],e.fetch(a.currentUser.venues[0].id).then(function(a){angular.copy(a[0],i.currentPhone),j(),l()}),i.clearButton=function(a,b,c,d){"undefined"!=typeof a.value.story_id&&k(a.value.story_id),a.value.story_id="",a.value.title="",a.value.created_at="",a.value.url=""},i.isFixed=function(a){for(var b in a)return"*"===b||"#"===b||"0"===b||"PR"===b},b.$on("droppedElement",function(a,c){var d,f,g=c.dragObj,h=c.dropObj;f=p(h),q(g);for(var i in f)d=f[i].story_id,f[i].title=g.title,f[i].url=g.url,f[i].story_id=g.id;"undefined"!=typeof d&&b.$apply(k(d)),e.assignButton(f).then(function(a){})});var j=function(){d.fetch().then(function(a){m(o(a))})},k=function(a){d.fetchOne(a).then(function(a){i.availableStories.push(a)})},l=function(){angular.forEach(a.currentUser.venues,function(a,b,c){f.fetchOne(a.id).then(function(a){i.venues.push(a),m(a.stories)})})},m=function(a){angular.forEach(a,function(a,b,c){n(a.id)||i.availableStories.push(a)})},n=function(a){var b=i.currentPhone.buttons.filter(function(b,c,d){var e=Object.getOwnPropertyNames(b)[0],f=b[e].story_id.toString();return f===a.toString()});return b.length>0},o=function(a){return a.filter(function(a){return"ishmaels"===a.story_type?a:void 0})},p=function(a){return i.currentPhone.buttons.filter(function(b,c,d){for(var e in b)if(e===Object.keys(a)[0])return b})[0]},q=function(a){angular.forEach(i.availableStories,function(b,c){b.id===a.id&&i.availableStories.splice(c,1)})}}angular.module("MainController",[]),angular.module("MainDirective",[]),angular.module("phoneApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","MainDirective","MainController"]).run(["$rootScope","$routeParams","$window","$http","$location","AuthFactory","VenueFactory","PhoneFactory","StoryFactory","trace",function(a,b,c,d,e,f,g,h,i,j){if(f.isAuthenticated()||"/confirm"!==e.path())if(f.isAuthenticated()||"/passwordreset"!==e.path())if(f.isAuthenticated()){var k=JSON.parse(c.localStorage.getItem("cmi-user"));d.defaults.headers.common.Authorization="Token token="+k.token}else e.path("/");else j("location is /passwordreset and there is no currentUser");else j("all is well");a.$on("$routeChangeStart",function(a,b){if("/confirm"!==e.path()||f.isAuthenticated())if(f.isAuthenticated()||"/passwordreset"!==e.path())if(f.isAuthenticated()){var g=JSON.parse(c.localStorage.getItem("cmi-user"));d.defaults.headers.common.Authorization="Token token="+g.token}else e.path("/");else j("location is /passwordreset and there is no currentUser");else j("all is well");f.isAuthenticated()&&"venue_admin"===f.currentUser().role&&"/dashboard"===e.path()&&e.path("/venues")}),f.isAuthenticated()&&"venue_admin"===f.currentUser().role&&"/dashboard"===e.path()&&e.path("/phones")}]).config(["$sceDelegateProvider",function(a){a.resourceUrlWhitelist(["self","https://s3-us-west-2.amazonaws.com/**"])}]),angular.module("phoneApp").config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeController",controllerAs:"homeController"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/confirm",{templateUrl:"views/confirm-account.html"}).when("/login",{templateUrl:"views/login.html",controller:"LoginController",controllerAs:"loginController"}).when("/dashboard",{templateUrl:"views/dashboard.html"}).when("/venue-stats",{templateUrl:"views/venue.html"}).when("/phone-stats",{templateUrl:"views/admin-phone.html"}).when("/story-stats",{templateUrl:"views/story.html"}).when("/fixed",{templateUrl:"views/fixed.html"}).when("/add-new",{templateUrl:"views/add-new.html"}).when("/phones",{templateUrl:"views/phone-show.html"}).when("/manage-phone",{templateUrl:"views/manage-phone.html",controller:"PhoneController",controllerAs:"phoneController"}).when("/venues/:venueId",{templateUrl:"views/venue-show.html"}).when("/confirm",{templateUrl:"views/confirm.html",controller:"LoginController",controllerAs:"loginController"}).when("/passwordreset",{templateUrl:"views/resetpassword.html",controller:"LoginController",controllerAs:"loginController"}).otherwise({redirectTo:"/phones"})}]),angular.module("phoneApp").constant("_",window._).constant("ServerUrl","https://callmeishmael-api.herokuapp.com"),angular.module("phoneApp").service("trace",function(){return function(){for(var a=0;a<arguments.length;a++)console.log(arguments[a])}}),angular.module("phoneApp").service("storyTypes",function(){return function(){return["Fixed","Venue","Surprise","Ishmael’s"]}}),angular.module("phoneApp").filter("storyFilter",["trace","StoryFactory",function(a,b){return function(a,b){var c=[],d=b||"^$",e=new RegExp("("+d+")","ig");return angular.forEach(a,function(a,b){var d=a.title.search(e),f=a.author_last.search(e);(-1!==d||-1!==f)&&c.push(a)}),c}}]),angular.module("phoneApp").filter("reverse",function(){return function(a){return"undefined"!=typeof a?a.slice().reverse():void 0}}),angular.module("phoneApp").factory("AuthFactory",["$location","$rootScope","$http","$window","$q","ServerUrl","trace",function(a,b,c,d,e,f,g){var h=[],i=function(){return e(function(a,d){c.get(f+"/admin/users").success(function(b){angular.copy(b,h),a(b)}).error(function(a,c,e,f){d(a),b.alert="Unsuccessful attempt to retreive all users because:"+a+"\n"+c})})},j=function(a){return c.post(f+"/login",a).success(function(a,c,e,f){r(a),b.currentUser=JSON.parse(d.localStorage.getItem("cmi-user")),g(c),b.$broadcast("alert",{alert:"Log in successful.",status:c})}).error(function(a,c,d,e){b.$broadcast("alert",{alert:"Your email and/or password are incorrect.",status:c})})},k=function(){return c.get(f+"/logout").success(function(a,c,e,f){g(a),d.localStorage.removeItem("cmi-user"),b.currentUser=null,b.$broadcast("alert",{alert:"You have successfully logged out.",status:c})})},l=function(){return!!d.localStorage.getItem("cmi-user")},m=function(a){return c.post(f+"/users",{user:a}).success(function(a,c,d,e){g(a),b.$broadcast("alert",{alert:"New user successfully created.",status:c})}).error(function(a,c,d,e){b.$broadcast("alert",{alert:"New user successfully created.",status:c}),g(a,c,d,e,"you are so stupid, you are doing it wrong")})},n=function(a){return c.patch(f+"/admin/users/"+a.id,{user:a}).success(function(a,c,d,e){b.confirmed=!0,b.$broadcast("alert",{alert:"User updated successfully.",status:c})}).error(function(a,c,d,e){b.$broadcast("alert",{alert:"User was not updated successfully.",status:c})})},o=function(){return b.currentUser=JSON.parse(d.localStorage.getItem("cmi-user"))},p=function(a){return c.get(f+"/resetpassword?email="+a.email)},q=function(a){return c.patch(f+"/admin/users/"+a.id,{user:a}).success(function(a,c,d,e){g(a),b.$broadcast("alert",{alert:"Your password was successfully changed.",status:c})}).error(function(a,c,d,e){g("error changing new password: ",a,c,d,e),b.$broadcast("alert",{alert:"Your password was not successfully changed.",status:c})})},r=function(a){d.localStorage.setItem("cmi-user",JSON.stringify(a)),c.defaults.headers.common.Authorization="Token token="+a.token};return{users:h,fetchUsers:i,login:j,logout:k,isAuthenticated:l,postNewUser:m,updateUser:n,currentUser:o,sendPasswordLink:p,submitNewPassword:q}}]),angular.module("phoneApp").factory("PhoneFactory",["trace","$rootScope","$http","$q","ServerUrl",function(a,b,c,d,e){var f=[],g=function(b){return d(function(d,g){c.get(e+"/venues/"+b+"/phones").success(function(a,b,c,e){d(a),angular.copy(a,f)}).error(function(b,c,d,e){a(b,c,d,e,"phone request failed.")})})},h=function(){return d(function(a,b){c.get(e+"/phones").success(function(b,c,d,e){a(b)}).error(function(a,c,d,e){b(a)})})},i=function(a){return d(function(d,f){c.post(e+"/venues/"+a.phone.venueId+"/phones",a).success(function(a,c,e,f){b.$broadcast("alert",{alert:"The phone has been created.",status:c}),d(a)}).error(function(a,c,d,e){b.$broadcast("alert",{alert:"There was an error and the requested action failed.",status:c}),f(a,c,d,e)})})},j=function(a){return d(function(d,f){c["delete"](e+"/venues/"+a.phone.venue.id+"/phones/"+a.phone.id).success(function(a,c,e,f){b.$broadcast("alert",{alert:"The phone has been deleted.",status:c}),d(a)}).error(function(a,c,d,e){b.$broadcast("alert",{alert:"There was an error and the requested action failed.",status:c}),f(a,c,d,e)})})},k=function(a){var f,g;for(var h in a)f=a[h].button_id.toString(),g=a[h].story_id.toString();return d(function(a,d){c.patch(e+"/buttons/"+f,{button:{story_id:g}}).success(function(c,d,e,f){b.$broadcast("alert",{alert:"Button "+c.assignment+" was successfully changed to "+c.story.title+". Changes to your phone will take effect tomorrow.",status:d}),a(c)}).error(function(a,c,e,f){b.$broadcast("alert",{alert:"Sorry, there was an issue with that request.",status:c}),d(a,c,e,f)})})};return{fetch:g,phones:f,get:h,post:i,assignButton:k,destroy:j}}]),angular.module("phoneApp").factory("VenueFactory",["trace","$window","$rootScope","ServerUrl","$q","$http",function(a,b,c,d,e,f){var g=[],h=function(){return e(function(a,b){f.get(d+"/venues").success(function(b){angular.copy(b,g),a(b)}).error(function(a,c,d,e){b(a,c,d,e)})})},i=function(a){return e(function(b,c){f.get(d+"/venues/"+a).success(function(a){b(a)}).error(function(a,b,d,e){c(a,b,d,e)})})},j=function(a){return a.venue.user_ids=l(a.venue.user_ids),e(function(b,e){f.post(d+"/venues",a).success(function(a){c.alert="Your venue was successfully created",b(a)}).error(function(a,b,d,f){c.alert="Sorry, there was an issue with that request: Status "+b,e(a)})})},k=function(a){return e(function(b,e){f["delete"](d+"/venues/"+a.venue.id).success(function(a){c.alert="Your venue was successfully deleted",b(a)}).error(function(a,b,d,f){c.alert="Sorry, there was an issue with that request: Status "+b,e(a)})})},l=function(a){var b=[];for(var c in a)a[c].checked&&b.push(c);return b};return{fetch:h,fetchOne:i,venues:g,post:j,destroy:k}}]),angular.module("phoneApp").factory("StoryFactory",["trace","$window","$rootScope","ServerUrl","$q","$http",function(a,b,c,d,e,f){var g=[],h=function(){return e(function(b,c){f.get(d+"/stories").success(function(a){angular.copy(a,g),b(a)}).error(function(b,c,d,e){a(b,c,d,e)})})},i=function(b){return e(function(c,e){f.get(d+"/stories/"+b).success(function(a){c(a)}).error(function(b,c,d,f){a(b,c,d,f),e(b,c,d,f)})})},j=function(a){return a.story.story_type=l(a.story.story_type),e(function(b,e){f.post(d+"/stories",a).success(function(a,d,e,f){c.$broadcast("alert",{alert:"The story was created successfully.",status:d}),b(a)}).error(function(a,b,d,f){c.$broadcast("alert",{alert:"There was an error and the story was not created successfully.",status:b}),e(a,b,d,f)})})},k=function(a){return e(function(b,e){f["delete"](d+"/stories/"+a.story.id).success(function(a,d,e,f){c.alert="Your venue was successfully deleted",b(a)}).error(function(a,b,c,d){e({data:a,status:b,headers:c,config:d})})})},l=function(a){return a.toLowerCase().replace(/[\-\s\—\–\”’“‘\',;]/,"")};return{fetch:h,fetchOne:i,stories:g,post:j,destroy:k}}]),angular.module("phoneApp").filter("venuesFilter",["trace",function(a){}]),angular.module("MainDirective").directive("navbar",["trace",function(a){return{restrict:"E",templateUrl:"views/navbar.html",controller:"NavbarController",controllerAs:"navbarController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("sidenav",["trace",function(a){return{restrict:"E",templateUrl:"views/sidenav.html",controller:"SidenavController",controllerAs:"sidenavController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("cmiDashboard",["trace",function(a){return{restrict:"E",templateUrl:"views/admin-dashboard.html",controller:"DashboardController",controllerAs:"dashboardController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("cmiPhoneShowDashboard",["trace",function(a){return{restrict:"E",scope:"=",templateUrl:"views/phone-show-dashboard.html",controller:"VenueController",controllerAs:"venueController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("cmiAdminPhoneDashboard",["PhoneFactory","trace",function(a,b){return{restrict:"E",templateUrl:"views/admin-phone-dashboard.html",controller:"DashboardController",controllerAs:"dashboardController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("cmiStoryDashboard",["trace",function(a){return{restrict:"E",templateUrl:"views/story-dashboard.html",controller:"DashboardController",controllerAs:"dashboardController",bindToController:!0,scope:"=",link:function(a,b,c){}}}]),angular.module("MainDirective").directive("cmiFormsDashboard",["trace",function(a){return{restrict:"E",templateUrl:"views/forms-dashboard.html",controller:"FormsController",controllerAs:"formsController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("ngConfirmClick",["trace","$window",function(a,b){return{restrict:"A",replace:!1,scope:"=",link:function(a,c,d){var e=d.ngConfirmClick||"Are you sure?",f=d.confirmedClickAction;c.bind("click",function(c){b.confirm(e)&&a.$eval(f)})}}}]),angular.module("MainDirective").directive("cmiVenueDashboard",["VenueFactory","trace",function(a,b){return{restrict:"E",templateUrl:"views/venue-dashboard.html",controller:"DashboardController",controllerAs:"dashboardController",bindToController:!0,link:function(a,b,c){}}}]),angular.module("MainDirective").directive("ajaxSpinner",["trace","$http",function(a,b){return{restrict:"A",link:function(a,c,d){a.isLoading=function(){return b.pendingRequests.length>0},a.$watch(a.isLoading,function(a){a?(c.addClass("active").find("i.fa").addClass("fa-cog fa-spin"),$("html, body").addClass("ajax-progress")):(c.removeClass("active").find("i.fa").removeClass("fa-cog fa-spin"),$("html, body").removeClass("ajax-progress"))})}}}]),angular.module("MainDirective").directive("cmiDialListitem",["trace","$compile",function(a,b){return{restrict:"EA",scope:{button:"="},compile:function(){return function(a,b,c){var d,e;a.$watch("button",function(a,c){0===Object.keys(a).length,d=b.find(".button-story"),e=b.find(".button-story .audio audio")})}}}}]),angular.module("MainDirective").directive("cmiAudioPlayer",["$rootScope","trace",function(a,b){return{restrict:"E",templateUrl:"views/audio-player.html",scope:{url:"@"},compile:function(){return function(a,b,c){var d=b.find("audio");a.toggleAudio=function(){a.playing===!0?d[0].pause():d[0].play(),a.playing=!a.playing}}}}}]),angular.module("MainDirective").directive("cmiDraggable",["$rootScope","trace",function(a,b){return{restrict:"EA",scope:{story:"="},compile:function(){return function(a,b,c){$(b).draggable({cursor:"pointer",revert:"invalid",drag:function(a,b){},start:function(a,b){},stop:function(a,b){}})}}}}]),angular.module("MainDirective").directive("cmiDroppable",["$rootScope","trace",function(a,b){return{restrict:"EA",scope:{button:"="},compile:function(){return function(b,c,d){setTimeout(function(){$(c).droppable({drop:function(c,d){var e,f=angular.element(d.draggable).data("uid"),g=(angular.element(d.draggable).parent(),angular.element(this),$(d.draggable).offset().left-$(this).offset().left),h=$(d.draggable).offset().top-$(this).offset().top,i=parseInt($(d.draggable).css("left"))-g,j=parseInt($(d.draggable).css("top"))-h,k=parseInt($(this).css("width")),l=parseInt($(this).css("height"));$(d.draggable).animate({width:k,height:l,top:j,left:i},100,function(){$(this).fadeOut(400,function(){$(this).remove()})}),e=b.$parent.phoneController.availableStories.filter(function(a,b,c){return a.id===f?a:void 0})[0],a.$broadcast("droppedElement",{dragObj:e,dropObj:b.button}),b.$apply()},hoverClass:"cmi-droppable-hover",revert:"invalid",disabled:c.hasClass("nonEditable")})},1e3)}}}}]),angular.module("MainDirective").directive("cmiAlert",["$rootScope","trace",function(a,b){return{restrict:"E",templateUrl:"views/alert.html",link:function(a,b,c){a.dismissAlert=function(){var b=$(".alert");b.fadeOut(250,function(){a.alert=""})},a.$on("alert",function(b,c){a.alert=c.alert,a.status=c.status,setTimeout(function(){a.dismissAlert()},1e4)})}}}]),angular.module("phoneApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("MainController").controller("NavbarController",navbarController),navbarController.$inject=["trace","$location","AuthFactory"],angular.module("MainController").controller("LoginController",loginController),loginController.$inject=["$rootScope","$location","AuthFactory","trace"],angular.module("MainController").controller("SidenavController",sidenavController),sidenavController.$inject=["trace","$location","$routeParams"],angular.module("MainController").controller("DashboardController",dashboardController),dashboardController.$inject=["trace","VenueFactory","PhoneFactory","StoryFactory","storyTypes"],angular.module("MainController").controller("HomeController",homeController),homeController.$inject=["trace","$location","AuthFactory"],angular.module("MainController").controller("FormsController",formsController),formsController.$inject=["trace","AuthFactory","PhoneFactory","StoryFactory","VenueFactory"],angular.module("MainController").controller("VenueController",venueController),venueController.$inject=["trace","$rootScope","$location","$routeParams","AuthFactory","VenueFactory","PhoneFactory","StoryFactory"],angular.module("MainController").controller("PhoneController",phoneController),phoneController.$inject=["$rootScope","$scope","AuthFactory","StoryFactory","PhoneFactory","VenueFactory","$sceDelegate","trace"];